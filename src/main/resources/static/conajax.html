<!DOCTYPE html>
<html>
<!-- 재민 제발~] -->
<head>
	<meta charset="utf-8">
	<title>다음 지도 API</title>
	<style>
		.wrap {
			position: absolute;
			left: 0;
			bottom: 40px;
			width: 288px;
			height: 132px;
			margin-left: -144px;
			text-align: left;
			overflow: hidden;
			font-size: 12px;
			font-family: 'Malgun Gothic', dotum, '돋움', sans-serif;
			line-height: 1.5;
		}

		.wrap * {
			padding: 0;
			margin: 0;
		}

		.wrap .info {
			width: 286px;
			height: 120px;
			border-radius: 5px;
			border-bottom: 2px solid #ccc;
			border-right: 1px solid #ccc;
			overflow: hidden;
			background: #fff;
		}

		.wrap .info:nth-child(1) {
			border: 0;
			box-shadow: 0px 1px 2px #888;
		}

		.info .title {
			padding: 5px 0 0 10px;
			height: 30px;
			background: #eee;
			border-bottom: 1px solid #ddd;
			font-size: 18px;
			font-weight: bold;
		}

		.info .close {
			position: absolute;
			top: 10px;
			right: 10px;
			color: #888;
			width: 17px;
			height: 17px;
			background: url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/overlay_close.png');
		}

		.info .close:hover {
			cursor: pointer;
		}

		.info .body {
			position: relative;
			overflow: hidden;
		}

		.info .desc {
			position: relative;
			margin: 13px 0 0 90px;
			height: 75px;
		}

		.desc .ellipsis {
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}

		.desc .jibun {
			font-size: 11px;
			color: #888;
			margin-top: -2px;
		}

		.info .img {
			position: absolute;
			top: 6px;
			left: 5px;
			width: 73px;
			height: 71px;
			border: 1px solid #ddd;
			color: #888;
			overflow: hidden;
		}

		.info:after {
			content: '';
			position: absolute;
			margin-left: -12px;
			left: 50%;
			bottom: 0;
			width: 22px;
			height: 12px;
			background: url('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/vertex_white.png')
		}

		.info .link {
			color: #5085BB;
		}
	</style>
</head>

<body>
    <!-- 검색창 추가 -->
    <div>
        <input type="text" id="addressInput" placeholder="주소를 입력하세요">
        <button onclick="searchAddress()">검색</button>
    </div>

    <div id="map" style="width:100%;height:90vh;"></div>

    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=f8bbc7549216335625367284bd469f94&libraries=clusterer,services"></script>
    <script>
        var mapContainer = document.getElementById('map');
        var mapOption = {
            center: new kakao.maps.LatLng(37.56692, 126.97845),
            level: 3,
            mapTypeId: kakao.maps.MapTypeId.ROADMAP
        };
        
        var currentOverlay = null;

        function closeOverlay() {
            if (currentOverlay) {
                currentOverlay.setMap(null);
            }
        }

        function attachOverlay(marker, content) {
            kakao.maps.event.addListener(marker, 'click', function () {
                closeOverlay();

                var overlay = new kakao.maps.CustomOverlay({
                    content: content,
                    map: map,
                    position: marker.getPosition()
                });

                currentOverlay = overlay;
            });
        }

        function searchAddress() {
            var addressInput = document.getElementById('addressInput');
            var address = addressInput.value;

            if (address) {
                var geocoder = new kakao.maps.services.Geocoder();

                geocoder.addressSearch(address, function (result, status) {
                    if (status === kakao.maps.services.Status.OK && result.length > 0) {
                        // 주소로 검색된 좌표로 지도 중심 이동
                        map.setCenter(new kakao.maps.LatLng(result[0].y, result[0].x));
                    } else {
                        alert('주소를 찾을 수 없습니다.');
                    }
                });
            } else {
                alert('주소를 입력하세요.');
            }
        }

		// 지도를 생성한다 
		var map = new kakao.maps.Map(mapContainer, mapOption);
		//********여기까지는 지도 생성************

		// 지도 타입 변경 컨트롤을 생성한다
		var mapTypeControl = new kakao.maps.MapTypeControl();

		// 지도의 상단 우측에 지도 타입 변경 컨트롤을 추가한다
		map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

		// 지도에 확대 축소 컨트롤을 생성한다
		var zoomControl = new kakao.maps.ZoomControl();

		// 지도의 우측에 확대 축소 컨트롤을 추가한다
		map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
		//********여기까지는 지도 컨트롤***********

		// 마커 클러스터러를 생성합니다
		var clusterer = new kakao.maps.MarkerClusterer({
			map: map, // 마커들을 클러스터로 관리하고 표시할 지도 객체 
			averageCenter: true, // 클러스터에 포함된 마커들의 평균 위치를 클러스터 마커 위치로 설정 
			minLevel: 5 // 클러스터 할 최소 지도 레벨 
		});

		// AJAX를 통해 데이터를 가져옵니다.
		var xhr = new XMLHttpRequest();
		xhr.open("GET", "/conta", true);
		xhr.onreadystatechange = function () {
			if (xhr.readyState === 4 && xhr.status === 200) {
				var data = JSON.parse(xhr.responseText).datas;

				var markers = [];

				for (var i = 0; i < data.length; i++) {
					var marker = new kakao.maps.Marker({
						position: new kakao.maps.LatLng(data[i].we, data[i].kyung), //좌표,좌표
						map: map
					});

					markers.push(marker); // makers라는 변수안에 maker를 넣음

					// 마커를 클릭했을 때 커스텀 오버레이를 표시합니다
					var content = '<div class="wrap">' +
						'    <div class="info">' +
						'        <div class="title">' +
						'            창고 정보' +  // 제목을 변경
						'            <div class="close" onclick="closeOverlay()" title="닫기"></div>' +
						'        </div>' +
						'        <div class="body">' +
						'            <div class="img">' +
						'                <img src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/thumnail.png" width="73" height="70">' +
						'           </div>' +
						'            <div class="desc">' +
						'                <div class="ellipsis">회사명: ' + data[i].con_name + '</div>' +  // 데이터를 표시
						'                <div class="ellipsis">주소: ' + data[i].con_addr + '</div>' +  // 데이터를 표시
						'                <div class="ellipsis">면적: ' + data[i].con_area + ' ㎡</div>' +  // 데이터를 표시
						'				<div><a href="index.html" target="_blank" onclick="openPopup()">상세보기</a></div>' +
						'            </div>' +
						'    </div>' +
						'</div>';

					// 마커를 클릭했을 때 커스텀 오버레이를 표시합니다
					attachOverlay(marker, content);
				}

				// 클러스터러에 마커들을 추가
				clusterer.addMarkers(markers);
			}
		};
		xhr.send();

		// 커스텀 오버레이를 닫기 위해 호출되는 함수입니다 
		function closeOverlay() {
			if (currentOverlay) {
				currentOverlay.setMap(null);
			}
		}

		// 현재 표시 중인 오버레이를 저장하는 변수
		var currentOverlay = null;

		// 마커를 클릭했을 때 커스텀 오버레이를 표시하는 함수
		function attachOverlay(marker, content) {
			kakao.maps.event.addListener(marker, 'click', function () {
				// 기존 오버레이가 있으면 닫기
				closeOverlay();

				var overlay = new kakao.maps.CustomOverlay({
					content: content,
					map: map,
					position: marker.getPosition()
				});

				// 클릭한 마커에 대한 오버레이를 현재 오버레이로 저장
				currentOverlay = overlay;
			});
		}
		// 팝업을 열기 위한 함수
		function openPopup() {
			window.open("index.html", "_blank", "width=600, height=400");
		}
	</script>

</body>

</html>